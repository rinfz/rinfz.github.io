<!DOCTYPE html>
<!DOCTYPE html><html lang="en" class="astro-JT6RN32W">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Personal website of Matt R: programming, gamedev, music, tech and bird watching">
  <link rel="icon" type="image/x-icon" href="/images/favicon.png">
  <title>Barely Laughing - Count set bits in a vector with std::transform_reduce</title>
<link rel="stylesheet" href="/assets/8ddf6414.1714f76b.css" />
<link rel="stylesheet" href="/assets/4d864971.6377c02c.css" /></head>

<body class="astro-JT6RN32W">
  <div class="min-h-screen bg-gray-100 w-full sm:w-2/3 xl:w-3/5 max-w-screen-md mx-auto px-5 pb-0 sm:pb-5 astro-JT6RN32W">
    <header class="text-center py-10 border-b border-emerald-500 mb-2.5 text-sm font-semibold astro-JT6RN32W">
      <h1 class="astro-JT6RN32W">A Delightful Abstraction</h1>
    </header>

    <nav class="flex flex-col md:flex-row items-center border-b border-emerald-500 mb-5 pb-2.5 astro-JT6RN32W">
      <ul class="flex gap-5 flex-1 items-center astro-JT6RN32W">
        <li class="astro-JT6RN32W"><a href="/" class="astro-JT6RN32W">Home</a></li>
        <li class="astro-JT6RN32W"><a href="/posts" class="astro-JT6RN32W">Posts</a></li>
        <li class="astro-JT6RN32W"><a href="/birds" class="astro-JT6RN32W">Birds</a></li>
        <li class="astro-JT6RN32W"><a href="/photos" class="astro-JT6RN32W">Photography</a></li>
        <li class="astro-JT6RN32W"><a href="https://readwarbler.com/" target="_blank" class="astro-JT6RN32W">Reader</a></li>
      </ul>
      <p class="text-xs mt-3 md:mt-0"><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
    </nav>

    <article class="text-justify">
    <h2>Count set bits in a vector with std::transform_reduce</h2>
    <p class="pt-0 mb-5">2019-10-23</p>
    <pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">cstdio</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">vector</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">random</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">bitset</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">numeric</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">functional</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">execution</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">chrono</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">int</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">main</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">int</span><span style="color: #A6ACCD"> N </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">5</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::random_device rng;</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::mt19937 engine{</span><span style="color: #ADD7FF">rng</span><span style="color: #A6ACCD">()};</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::uniform_int_distribution</span><span style="color: #91B4D5">&lt;uint8_t&gt;</span><span style="color: #A6ACCD"> dist{</span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">, </span><span style="color: #5DE4C7">1</span><span style="color: #A6ACCD">};</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">auto</span><span style="color: #A6ACCD"> gen </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [</span><span style="color: #91B4D5">&amp;</span><span style="color: #A6ACCD">] { return </span><span style="color: #ADD7FF">dist</span><span style="color: #A6ACCD">(engine); };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::vector</span><span style="color: #91B4D5">&lt;uint8_t&gt;</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">data</span><span style="color: #A6ACCD">(N);</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">generate</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">begin</span><span style="color: #A6ACCD">(), </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">end</span><span style="color: #A6ACCD">(), gen);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">auto</span><span style="color: #A6ACCD"> t1 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">chrono</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">uint64_t</span><span style="color: #A6ACCD"> result </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">transform_reduce</span><span style="color: #A6ACCD">(</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">execution</span><span style="color: #A6ACCD">::par_unseq,</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">cbegin</span><span style="color: #A6ACCD">(), </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">cend</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::plus</span><span style="color: #91B4D5">&lt;&gt;</span><span style="color: #A6ACCD">{},</span></span>
<span class="line"><span style="color: #A6ACCD">        [] (</span><span style="color: #5DE4C7">const</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">auto</span><span style="color: #5DE4C7">&amp;</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">n</span><span style="color: #A6ACCD">) { return </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">bitset</span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">8</span><span style="color: #A6ACCD">&gt;(n).</span><span style="color: #ADD7FF">count</span><span style="color: #A6ACCD">(); }</span></span>
<span class="line"><span style="color: #A6ACCD">    );</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">auto</span><span style="color: #A6ACCD"> t2 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">chrono</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">chrono</span><span style="color: #A6ACCD">::duration</span><span style="color: #91B4D5">&lt;double</span><span style="color: #A6ACCD">, </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::milli</span><span style="color: #91B4D5">&gt;</span><span style="color: #A6ACCD"> ms </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> t2 </span><span style="color: #91B4D5">-</span><span style="color: #A6ACCD"> t1;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #ADD7FF">printf</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">&quot;</span><span style="color: #E4F0FB">%ld</span><span style="color: #5DE4C7"> in </span><span style="color: #E4F0FB">%f</span><span style="color: #5DE4C7"> ms</span><span style="color: #5FB3A1">\n</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">, result, </span><span style="color: #E4F0FB">ms</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">count</span><span style="color: #A6ACCD">());</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre><p>Compile with: <code>g++-9 -std=c++17 a.cpp -ltbb</code></p>
  </article>
  </div>

</body></html>