<!DOCTYPE html>
<html lang="en" class="astro-SCKKX6R4">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="description" content="Personal website of Matt R: programming, music, tech, bird watching and other interests">
        <link rel="icon" type="image/x-icon" href="/images/favicon.png">
        <title>Barely Laughing - Count set bits in a vector with transform_reduce</title>
    <link rel="stylesheet" href="/_astro/birds.a42b81e3.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.d84417d5.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.8c1b21d6.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.417652d1.css" /></head>

    <body class="astro-SCKKX6R4">
        <div class="max-w-5xl min-h-screen w-full px-5 pb-0 sm:pb-5 astro-SCKKX6R4">
            <header class="bg-gradient-to-t from-gray-900 to-gray-8 00 text-center py-10 border border-gray-700 text-white mb-2.5 mt-2.5 text-sm font-semibold astro-SCKKX6R4">
                <h1 class="astro-SCKKX6R4"><a href="/" class="astro-SCKKX6R4">A Delightful Abstraction</a></h1>
            </header>

            <main class="flex flex-col md:flex-row gap-x-4 astro-SCKKX6R4">
                <nav class="w-full flex-none md:w-1/5 mb-2 astro-SCKKX6R4">
                    <ul id="nav-items" class="hidden md:block space-y-1 mb-3 astro-SCKKX6R4">
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/">Home</a></li>
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/posts">Posts</a></li>
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/birds">Bird List</a></li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/photos">Photography</a>
                        </li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="https://larusreader.com/" target="_blank">Online Reading App</a>
                        </li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="https://www.goodreads.com/review/list/164595825-matt-r?order=d&shelf=read&sort=date_updated" target="_blank">
                                My Goodreads
                            </a>
                        </li>
                    </ul>

                    <div class="flex md:block justify-between md:justify-items-start items-center md:items-start astro-SCKKX6R4">
                        <p class="text-xs astro-SCKKX6R4">
                            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="astro-SCKKX6R4">&copy; CC BY-SA 4.0</a>
                        </p>
                        <button class="block md:hidden astro-SCKKX6R4" id="toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 astro-SCKKX6R4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" class="astro-SCKKX6R4"></path>
                            </svg>
                        </button>
                    </div>
                </nav>

                <div class="main-w flex-1 astro-SCKKX6R4">
                    
  <article class="text-justify astro-GVPN4U4B">
    <h2 class="astro-GVPN4U4B">Count set bits in a vector with transform_reduce</h2>
    <p class="pt-0 astro-GVPN4U4B">2019-10-23</p>
    <pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;cstdio></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;vector></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;random></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;bitset></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;numeric></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;functional></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;execution></span></span>
<span class="line"><span style="color: #F97583">#include</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">&#x3C;chrono></span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">int</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">int</span><span style="color: #E1E4E8"> N </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">5'000'000</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::random_device rng;</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::mt19937 engine{</span><span style="color: #B392F0">rng</span><span style="color: #E1E4E8">()};</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::uniform_int_distribution</span><span style="color: #F97583">&#x3C;uint8_t></span><span style="color: #E1E4E8"> dist{</span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">1</span><span style="color: #E1E4E8">};</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> gen </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [</span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">] { </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">dist</span><span style="color: #E1E4E8">(engine); };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::vector</span><span style="color: #F97583">&#x3C;uint8_t></span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">data</span><span style="color: #E1E4E8">(N);</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">generate</span><span style="color: #E1E4E8">(data.</span><span style="color: #B392F0">begin</span><span style="color: #E1E4E8">(), data.</span><span style="color: #B392F0">end</span><span style="color: #E1E4E8">(), gen);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> t1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">chrono</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">high_resolution_clock</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">now</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">uint64_t</span><span style="color: #E1E4E8"> result </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">transform_reduce</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">execution</span><span style="color: #E1E4E8">::par_unseq,</span></span>
<span class="line"><span style="color: #E1E4E8">        data.</span><span style="color: #B392F0">cbegin</span><span style="color: #E1E4E8">(), data.</span><span style="color: #B392F0">cend</span><span style="color: #E1E4E8">(),</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">0</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::plus</span><span style="color: #F97583">&#x3C;></span><span style="color: #E1E4E8">{},</span></span>
<span class="line"><span style="color: #E1E4E8">        [] (</span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">auto&#x26;</span><span style="color: #E1E4E8"> </span><span style="color: #FFAB70">n</span><span style="color: #E1E4E8">) { </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">bitset</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">8</span><span style="color: #E1E4E8">>(n).</span><span style="color: #B392F0">count</span><span style="color: #E1E4E8">(); }</span></span>
<span class="line"><span style="color: #E1E4E8">    );</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">auto</span><span style="color: #E1E4E8"> t2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">chrono</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">high_resolution_clock</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">now</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::</span><span style="color: #B392F0">chrono</span><span style="color: #E1E4E8">::duration</span><span style="color: #F97583">&#x3C;double</span><span style="color: #E1E4E8">, </span><span style="color: #B392F0">std</span><span style="color: #E1E4E8">::milli</span><span style="color: #F97583">></span><span style="color: #E1E4E8"> ms </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> t2 </span><span style="color: #F97583">-</span><span style="color: #E1E4E8"> t1;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">printf</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"</span><span style="color: #79B8FF">%ld</span><span style="color: #9ECBFF"> in </span><span style="color: #79B8FF">%f</span><span style="color: #9ECBFF"> ms</span><span style="color: #79B8FF">\n</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">, result, ms.</span><span style="color: #B392F0">count</span><span style="color: #E1E4E8">());</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>Compile with: <code>g++-9 -std=c++17 a.cpp -ltbb</code></p>
  </article>

                </div>
            </main>
        </div>

        <script type="text/javascript">
            const button = document.getElementById("toggle-btn");
            const navItems = document.getElementById("nav-items");

            button.addEventListener('click', () => {
                navItems.classList.toggle('hidden');
                if (navItems.classList.contains('hidden')) {
                    button.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg>';
                } else {
                    button.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                }
            });
        </script>
    </body>
</html>