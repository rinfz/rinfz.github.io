<!DOCTYPE html>
<!DOCTYPE html><html lang="en" class="astro-MQCNRQCS">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Personal website of Matt R: programming, gamedev, music, tech and bird watching">
  <link rel="icon" type="image/x-icon" href="/images/favicon.png">
  <title>Barely Laughing - GCC 9.1 Execution Policies</title>
<link rel="stylesheet" href="/assets/75d84977.86d58a92.css" />
<link rel="stylesheet" href="/assets/31ba2e78.bb4e511a.css" /></head>

<body class="astro-MQCNRQCS">
  <div class="w-full sm:w-2/3 xl:w-3/5 mx-auto px-5 sm:px-0 astro-MQCNRQCS">
    <header class="text-center py-10 border-b border-teal-800 mb-2.5 text-sm font-semibold astro-MQCNRQCS">
      <h1 class="astro-MQCNRQCS">Barely Laughing</h1>
    </header>

    <nav class="flex flex-col sm:flex-row items-center border-b border-teal-800 mb-5 pb-2.5 astro-MQCNRQCS">
      <ul class="flex gap-5 flex-1 items-center astro-MQCNRQCS">
        <li class="astro-MQCNRQCS"><a href="/" class="astro-MQCNRQCS">Home</a></li>
        <li class="astro-MQCNRQCS"><a href="/posts" class="astro-MQCNRQCS">Posts</a></li>
        <li class="astro-MQCNRQCS"><a href="/photos" class="astro-MQCNRQCS">Photography</a></li>
        <li class="astro-MQCNRQCS"><a href="https://github.com/rinfz" target="_blank" class="astro-MQCNRQCS">Github</a></li>
      </ul>
      <p class="text-xs mt-3 sm:mt-0"><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
    </nav>

    <article class="text-justify">
    <h2>GCC 9.1 Execution Policies</h2>
    <p class="pt-0 mb-5">2019-06-24</p>
    <p>After reading about <a href="https://en.cppreference.com/w/cpp/algorithm"><algorithm></algorithm></a> I decided to do some proof of concept benchmarks with the <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2016/p0024r2.html">new execution policies in GCC 9.1</a> as I am writing some high performance C++ at work and it’d be good to know these things.</p><p>Given a very naive benchmark - generating random integers - we can see whether or not there will be any performance enhancements. The benefit to using algorithm is updating to parallel code is simply adding an argument to the function call which represents the execution policy you want to use. That means even if parallel execution isn’t going to be a net win, you haven’t lost much in the process.</p><p>First step is to get gcc 9.1. This is available as a prebuilt package on ubuntu.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #a6accd">sudo apt install g++-9 lib64stdc++-9-dev libtbb-dev</span></span></code></pre><p>The <code>libtbb</code> libraries were already installed for me so I just had to get the headers / development files.</p><p>Then a simple script. We tell it to generate 500 million ints so there will be a noticeable difference in timings.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">algorithm</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">chrono</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">execution</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">iostream</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">random</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"><span style="color: #A6ACCD">#include </span><span style="color: #A6ACCD">&lt;</span><span style="color: #5DE4C7">vector</span><span style="color: #A6ACCD">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">namespace</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">chrono</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">int</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">main</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">int</span><span style="color: #A6ACCD"> N </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">500</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::random_device rng;</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::mt19937 engine{</span><span style="color: #ADD7FF">rng</span><span style="color: #A6ACCD">()};</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::uniform_int_distribution</span><span style="color: #91B4D5">&lt;int&gt;</span><span style="color: #A6ACCD"> dist{</span><span style="color: #5DE4C7">1</span><span style="color: #A6ACCD">, </span><span style="color: #5DE4C7">1</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">&#39;</span><span style="color: #5DE4C7">000</span><span style="color: #A6ACCD">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">auto</span><span style="color: #A6ACCD"> gen </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [</span><span style="color: #91B4D5">&amp;</span><span style="color: #A6ACCD">] { return </span><span style="color: #ADD7FF">dist</span><span style="color: #A6ACCD">(engine); };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::vector</span><span style="color: #91B4D5">&lt;int&gt;</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">v</span><span style="color: #A6ACCD">(N);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">auto</span><span style="color: #A6ACCD"> start </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">generate</span><span style="color: #A6ACCD">(</span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">execution</span><span style="color: #A6ACCD">::seq, </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">begin</span><span style="color: #A6ACCD">(), </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">end</span><span style="color: #A6ACCD">(), gen);</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::cout </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">Seq: </span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">duration</span><span style="color: #A6ACCD">&lt;</span><span style="color: #91B4D5">double</span><span style="color: #A6ACCD">&gt;(</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">-</span><span style="color: #A6ACCD"> start).</span><span style="color: #ADD7FF">count</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">s</span><span style="color: #5FB3A1">\n</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  start </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">generate</span><span style="color: #A6ACCD">(</span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">execution</span><span style="color: #A6ACCD">::par, </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">begin</span><span style="color: #A6ACCD">(), </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">end</span><span style="color: #A6ACCD">(), gen);</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::cout </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">Par: </span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">duration</span><span style="color: #A6ACCD">&lt;</span><span style="color: #91B4D5">double</span><span style="color: #A6ACCD">&gt;(</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">-</span><span style="color: #A6ACCD"> start).</span><span style="color: #ADD7FF">count</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">s</span><span style="color: #5FB3A1">\n</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  start </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">generate</span><span style="color: #A6ACCD">(</span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">execution</span><span style="color: #A6ACCD">::par_unseq, </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">begin</span><span style="color: #A6ACCD">(), </span><span style="color: #E4F0FB">v</span><span style="color: #A6ACCD">.</span><span style="color: #ADD7FF">end</span><span style="color: #A6ACCD">(), gen);</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">std</span><span style="color: #A6ACCD">::cout </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">Par unseq: </span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">duration</span><span style="color: #A6ACCD">&lt;</span><span style="color: #91B4D5">double</span><span style="color: #A6ACCD">&gt;(</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">t</span><span style="color: #A6ACCD">::</span><span style="color: #91B4D5">high_resolution_clock</span><span style="color: #A6ACCD">::</span><span style="color: #ADD7FF">now</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">-</span><span style="color: #A6ACCD"> start).</span><span style="color: #ADD7FF">count</span><span style="color: #A6ACCD">() </span><span style="color: #91B4D5">&lt;&lt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">s</span><span style="color: #5FB3A1">\n</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  return </span><span style="color: #5DE4C7">0</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre><p>This feature is <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/status.html#status.iso.2017">c++17 only</a> (see “The Parallelism TS Should be Standardized”), and currently requires linking Intel’s libtbb. Compile it like so:</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #a6accd">g++-9 -std=c++17 test.cpp -ltbb -O3</span></span></code></pre><p>And after running it we get the following timings:</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #a6accd">Seq: 10.205s</span></span>
<span class="line"><span style="color: #a6accd">Par: 7.57447s</span></span>
<span class="line"><span style="color: #a6accd">Par unseq: 8.83137s</span></span></code></pre><p>Where the first part is the execution policy used and the second part is the total time to generate the integers in seconds.</p><p>It’s clear to see that par wins this comfortably. Nice to know we can basically get a free win with this feature. I haven’t yet understood why par_unseq is so much slower than normal par though.</p>
  </article>
  </div>
</body></html>