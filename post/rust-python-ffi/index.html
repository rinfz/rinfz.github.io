<!DOCTYPE html>
<html lang="en" class="astro-SCKKX6R4">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="description" content="Personal website of Matt R: programming, music, tech, bird watching and other interests">
        <link rel="icon" type="image/x-icon" href="/images/favicon.png">
        <title>Barely Laughing - Rust struct FFI and Python</title>
    <link rel="stylesheet" href="/_astro/birds.a42b81e3.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.e9941028.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.8c1b21d6.css" />
<link rel="stylesheet" href="/_astro/asm-collatz.2e7a78d0.css" /></head>

    <body class="astro-SCKKX6R4">
        <div class="max-w-5xl min-h-screen w-full px-5 pb-0 sm:pb-5 astro-SCKKX6R4">
            <header class="bg-gradient-to-t from-gray-900 to-gray-8 00 text-center py-10 border border-gray-700 text-white mb-2.5 mt-2.5 text-sm font-semibold astro-SCKKX6R4">
                <h1 class="astro-SCKKX6R4"><a href="/" class="astro-SCKKX6R4">A Delightful Abstraction</a></h1>
            </header>

            <main class="flex flex-col md:flex-row gap-x-4 astro-SCKKX6R4">
                <nav class="w-full flex-none md:w-1/5 mb-2 astro-SCKKX6R4">
                    <ul id="nav-items" class="hidden md:block space-y-1 mb-3 astro-SCKKX6R4">
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/">Home</a></li>
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/posts">Posts</a></li>
                        <li class="astro-SCKKX6R4"><a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/birds">Bird List</a></li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="/photos">Photography</a>
                        </li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="https://larusreader.com/" target="_blank">Online Reading App</a>
                        </li>
                        <li class="astro-SCKKX6R4">
                            <a class="block w-full text-center md:text-left bg-orange-600 px-1 py-2 hover:bg-orange-500 astro-SCKKX6R4" href="https://www.goodreads.com/review/list/164595825-matt-r?order=d&shelf=read&sort=date_updated" target="_blank">
                                My Goodreads
                            </a>
                        </li>
                    </ul>

                    <div class="flex md:block justify-between md:justify-items-start items-center md:items-start astro-SCKKX6R4">
                        <p class="text-xs astro-SCKKX6R4">
                            <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" class="astro-SCKKX6R4">&copy; CC BY-SA 4.0</a>
                        </p>
                        <button class="block md:hidden astro-SCKKX6R4" id="toggle-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 astro-SCKKX6R4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" class="astro-SCKKX6R4"></path>
                            </svg>
                        </button>
                    </div>
                </nav>

                <div class="main-w flex-1 astro-SCKKX6R4">
                    
  <article class="text-justify astro-GVPN4U4B">
    <h2 class="astro-GVPN4U4B">Rust struct FFI and Python</h2>
    <p class="pt-0 astro-GVPN4U4B">2019-10-17</p>
    <p>Given a basic struct:</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">pub</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">struct</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  x</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">i32</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  y</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">i32</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>If you want to use FFI and call this from, say, Python, you can’t take Point parameters in functions by reference because it will segfault.</p>
<p>Therefore you have to make use of <code>*const</code> and <code>*mut</code> for read-only and in/out parameters respectively.</p>
<p>To make the struct eligible for FFI, we whack a <code>#[repr(C)]</code> on it. For the purposes of this example, I will just overload the + operator (<a href="https://doc.rust-lang.org/std/ops/trait.Add.html">ripped straight from the docs</a>).</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">impl</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">std</span><span style="color: #F97583">::</span><span style="color: #B392F0">ops</span><span style="color: #F97583">::</span><span style="color: #B392F0">Add</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">for</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">type</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Output</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Self</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">fn</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">add</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">self</span><span style="color: #E1E4E8">, other</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Self</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">-></span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">Self</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">Self</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">          x</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">self</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">x </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> other</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">x,</span></span>
<span class="line"><span style="color: #E1E4E8">          y</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">self</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">y </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> other</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">y,</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>Note: this also means we stick <code>#[derive(Clone, Copy)]</code> on our Point struct.</p>
<p>I have been separating my FFI interface from the normal rust code as I am working on a dual-purpose codebase where we don’t need to export everything so it’s nice to keep the public API separate. So just put all the FFI functions in a <code>mod ffi</code> similar to how you would separate tests while keeping them in the same file.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">mod</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">ffi</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">use</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">super</span><span style="color: #F97583">::</span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  #[no_mangle]</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">pub</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">extern</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"C"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">fn</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">add_points</span><span style="color: #E1E4E8">(a</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">, b</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">) </span><span style="color: #F97583">-></span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">unsafe</span><span style="color: #E1E4E8"> { </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">a </span><span style="color: #F97583">+</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">b }</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">  #[no_mangle]</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">pub</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">extern</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"C"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">fn</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">add_points_inplace</span><span style="color: #E1E4E8">(a</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*mut</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">, b</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">) {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #F97583">unsafe</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">          (</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">a)</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">x </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">b)</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">x;</span></span>
<span class="line"><span style="color: #E1E4E8">          (</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">a)</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">y </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> (</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">b)</span><span style="color: #F97583">.</span><span style="color: #E1E4E8">y;</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre>
<p>The first example takes two immutable Points and returns a new Point to the caller. We have to use <code>unsafe</code> as we are dereferencing the points within the function body. This is nice and succinct.</p>
<p>The second example modifies the first parameter in place by taking it as a mutable pointer. No overload here as we don’t want to create a new Point.</p>
<p>Now on the python side of things, we setup using ctypes.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #F97583">from</span><span style="color: #E1E4E8"> ctypes </span><span style="color: #F97583">import</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Point</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">Structure</span><span style="color: #E1E4E8">):</span></span>
<span class="line"><span style="color: #E1E4E8">    _fields_ </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [(</span><span style="color: #9ECBFF">"x"</span><span style="color: #E1E4E8">, c_int), (</span><span style="color: #9ECBFF">"y"</span><span style="color: #E1E4E8">, c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">def</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">__str__</span><span style="color: #E1E4E8">(self):</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">f</span><span style="color: #9ECBFF">"Point(x=</span><span style="color: #79B8FF">{self</span><span style="color: #E1E4E8">.x</span><span style="color: #79B8FF">}</span><span style="color: #9ECBFF">, y=</span><span style="color: #79B8FF">{self</span><span style="color: #E1E4E8">.y</span><span style="color: #79B8FF">}</span><span style="color: #9ECBFF">)"</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">lib </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> cdll.LoadLibrary(</span><span style="color: #9ECBFF">"libexample.so"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">lib.add_points.argtypes </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [POINTER(Point), POINTER(Point)]</span></span>
<span class="line"><span style="color: #E1E4E8">lib.add_points.restype </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Point</span></span>
<span class="line"><span style="color: #E1E4E8">lib.add_points_inplace.argtypes </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> [POINTER(Point), POINTER(Point)]</span></span>
<span class="line"><span style="color: #E1E4E8">lib.add_points_inplace.restype </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">None</span></span></code></pre>
<p>The Point class inheriting from ctypes.Structure is the way to map external structs to Python objects. <code>_fields_</code> is special syntax (<a href="https://docs.python.org/3/library/ctypes.html#ctypes.Structure._fields_">docs link</a>). Add an overload for converting it to a string so we can see things have worked too.</p>
<p>After that Point class, we can load the .so and tell it what each function expects and what we expect it will return. We use <code>ctypes.POINTER</code> around the Point class as the rust functions do not expect args by value. <code>restype = None</code> is used when a function does not return a value.</p>
<p>After all that setup we can basically just call these functions like we would with any other code.</p>
<pre is:raw="" class="astro-code github-dark" style="background-color: #24292e; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color: #E1E4E8">p1 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Point(</span><span style="color: #79B8FF">10</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">10</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">p2 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Point(</span><span style="color: #79B8FF">15</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">21</span><span style="color: #E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">p3 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> lib.add_points(p1, p2)</span></span>
<span class="line"><span style="color: #79B8FF">print</span><span style="color: #E1E4E8">(p3)  </span><span style="color: #6A737D"># prints: Point(x=25, y=31)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">p4 </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> Point(</span><span style="color: #79B8FF">25</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">19</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">lib.add_points_inplace(p3, p4)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF">print</span><span style="color: #E1E4E8">(p3)  </span><span style="color: #6A737D"># prints: Point(x=50, y=50)</span></span></code></pre>
  </article>

                </div>
            </main>
        </div>

        <script type="text/javascript">
            const button = document.getElementById("toggle-btn");
            const navItems = document.getElementById("nav-items");

            button.addEventListener('click', () => {
                navItems.classList.toggle('hidden');
                if (navItems.classList.contains('hidden')) {
                    button.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg>';
                } else {
                    button.innerHTML =
                        '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                }
            });
        </script>
    </body>
</html>