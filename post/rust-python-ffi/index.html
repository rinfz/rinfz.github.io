<!DOCTYPE html>
<!DOCTYPE html><html lang="en" class="astro-JT6RN32W">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Personal website of Matt R: programming, gamedev, music, tech and bird watching">
  <link rel="icon" type="image/x-icon" href="/images/favicon.png">
  <title>Barely Laughing - Rust struct FFI and Python</title>
<link rel="stylesheet" href="/assets/fbad0101.77eca905.css" />
<link rel="stylesheet" href="/assets/b1bec7f9.73f136dc.css" /></head>

<body class="astro-JT6RN32W">
  <div class="min-h-screen bg-gray-100 w-full sm:w-2/3 xl:w-3/5 max-w-screen-md mx-auto px-5 pb-0 sm:pb-5 astro-JT6RN32W">
    <header class="text-center py-10 border-b border-emerald-500 mb-2.5 text-sm font-semibold astro-JT6RN32W">
      <h1 class="astro-JT6RN32W">A Delightful Abstraction</h1>
    </header>

    <nav class="flex flex-col md:flex-row items-center border-b border-emerald-500 mb-5 pb-2.5 astro-JT6RN32W">
      <ul class="flex gap-5 flex-1 items-center astro-JT6RN32W">
        <li class="astro-JT6RN32W"><a href="/" class="astro-JT6RN32W">Home</a></li>
        <li class="astro-JT6RN32W"><a href="/posts" class="astro-JT6RN32W">Posts</a></li>
        <li class="astro-JT6RN32W"><a href="/birds" class="astro-JT6RN32W">Birds</a></li>
        <li class="astro-JT6RN32W"><a href="/photos" class="astro-JT6RN32W">Photography</a></li>
        <li class="astro-JT6RN32W"><a href="https://readwarbler.com/" target="_blank" class="astro-JT6RN32W">Reader</a></li>
      </ul>
      <p class="text-xs mt-3 md:mt-0"><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
    </nav>

    <article class="text-justify">
    <h2>Rust struct FFI and Python</h2>
    <p class="pt-0 mb-5">2019-10-17</p>
    <p>Given a basic struct:</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #5DE4C7">pub</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">struct</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FB">x</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">i32</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FB">y</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">i32</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre><p>If you want to use FFI and call this from, say, Python, you can’t take Point parameters in functions by reference because it will segfault.</p><p>Therefore you have to make use of <code>*const</code> and <code>*mut</code> for read-only and in/out parameters respectively.</p><p>To make the struct eligible for FFI, we whack a <code>#[repr(C)]</code> on it. For the purposes of this example, I will just overload the + operator (<a href="https://doc.rust-lang.org/std/ops/trait.Add.html">ripped straight from the docs</a>).</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #5DE4C7">impl</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">std::ops::</span><span style="color: #A6ACCDC0">Add</span><span style="color: #A6ACCD"> for </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">type</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Output</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF; font-style: italic">Self</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7">fn</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">add</span><span style="color: #A6ACCD">(</span><span style="color: #ADD7FF; font-style: italic">self</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">other</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF; font-style: italic">Self</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">-&gt;</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF; font-style: italic">Self</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #ADD7FF; font-style: italic">Self</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">          </span><span style="color: #E4F0FB">x</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF; font-style: italic">self</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">x </span><span style="color: #91B4D5">+</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">other</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">x,</span></span>
<span class="line"><span style="color: #A6ACCD">          </span><span style="color: #E4F0FB">y</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF; font-style: italic">self</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">y </span><span style="color: #91B4D5">+</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">other</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">y,</span></span>
<span class="line"><span style="color: #A6ACCD">      }</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre><p>Note: this also means we stick <code>#[derive(Clone, Copy)]</code> on our Point struct.</p><p>I have been separating my FFI interface from the normal rust code as I am working on a dual-purpose codebase where we don’t need to export everything so it’s nice to keep the public API separate. So just put all the FFI functions in a <code>mod ffi</code> similar to how you would separate tests while keeping them in the same file.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #91B4D5">mod</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">ffi</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7">use</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">super</span><span style="color: #91B4D5">::</span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  #[no_mangle]</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7">pub</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">extern</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">C</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">fn</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">add_points</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">a</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #5DE4C7">const</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">b</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #5DE4C7">const</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">-&gt;</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #5DE4C7">unsafe</span><span style="color: #A6ACCD"> { </span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">a</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">+</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">b</span><span style="color: #A6ACCD"> }</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  #[no_mangle]</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7">pub</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">extern</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">C</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">fn</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">add_points_inplace</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">a</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #5DE4C7">mut</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">b</span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #5DE4C7">const</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCDC0">Point</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #5DE4C7">unsafe</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">          (</span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">a</span><span style="color: #A6ACCD">)</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">x </span><span style="color: #91B4D5">+=</span><span style="color: #A6ACCD"> (</span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">b</span><span style="color: #A6ACCD">)</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">x;</span></span>
<span class="line"><span style="color: #A6ACCD">          (</span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">a</span><span style="color: #A6ACCD">)</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">y </span><span style="color: #91B4D5">+=</span><span style="color: #A6ACCD"> (</span><span style="color: #91B4D5">*</span><span style="color: #E4F0FB">b</span><span style="color: #A6ACCD">)</span><span style="color: #91B4D5">.</span><span style="color: #A6ACCD">y;</span></span>
<span class="line"><span style="color: #A6ACCD">      }</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre><p>The first example takes two immutable Points and returns a new Point to the caller. We have to use <code>unsafe</code> as we are dereferencing the points within the function body. This is nice and succinct.</p><p>The second example modifies the first parameter in place by taking it as a mutable pointer. No overload here as we don’t want to create a new Point.</p><p>Now on the python side of things, we setup using ctypes.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #5DE4C7">from</span><span style="color: #A6ACCD"> ctypes </span><span style="color: #5DE4C7">import</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">class</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">Point</span><span style="color: #A6ACCD">(</span><span style="color: #ADD7FF">Structure</span><span style="color: #A6ACCD">):</span></span>
<span class="line"><span style="color: #A6ACCD">    _fields_ </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [(</span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">x</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">, c_int), (</span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">y</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">, c_int)]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">def</span><span style="color: #A6ACCD"> __str__(</span><span style="color: #E4F0FB">self</span><span style="color: #A6ACCD">):</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">f</span><span style="color: #5DE4C7">&quot;Point(x=</span><span style="color: #5DE4C7">{</span><span style="color: #ADD7FF; font-style: italic">self</span><span style="color: #A6ACCD">.x</span><span style="color: #5DE4C7">}</span><span style="color: #5DE4C7">, y=</span><span style="color: #5DE4C7">{</span><span style="color: #ADD7FF; font-style: italic">self</span><span style="color: #A6ACCD">.y</span><span style="color: #5DE4C7">}</span><span style="color: #5DE4C7">)&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">lib </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> cdll.LoadLibrary(</span><span style="color: #A6ACCD">&quot;</span><span style="color: #5DE4C7">libexample.so</span><span style="color: #A6ACCD">&quot;</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">lib.add_points.argtypes </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [POINTER(Point), POINTER(Point)]</span></span>
<span class="line"><span style="color: #A6ACCD">lib.add_points.restype </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> Point</span></span>
<span class="line"><span style="color: #A6ACCD">lib.add_points_inplace.argtypes </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [POINTER(Point), POINTER(Point)]</span></span>
<span class="line"><span style="color: #A6ACCD">lib.add_points_inplace.restype </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">None</span></span></code></pre><p>The Point class inheriting from ctypes.Structure is the way to map external structs to Python objects. <code>_fields_</code> is special syntax (<a href="https://docs.python.org/3/library/ctypes.html#ctypes.Structure._fields_">docs link</a>). Add an overload for converting it to a string so we can see things have worked too.</p><p>After that Point class, we can load the .so and tell it what each function expects and what we expect it will return. We use <code>ctypes.POINTER</code> around the Point class as the rust functions do not expect args by value. <code>restype = None</code> is used when a function does not return a value.</p><p>After all that setup we can basically just call these functions like we would with any other code.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">p1 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> Point(</span><span style="color: #5DE4C7">10</span><span style="color: #A6ACCD">, </span><span style="color: #5DE4C7">10</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">p2 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> Point(</span><span style="color: #5DE4C7">15</span><span style="color: #A6ACCD">, </span><span style="color: #5DE4C7">21</span><span style="color: #A6ACCD">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">p3 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> lib.add_points(p1, p2)</span></span>
<span class="line"><span style="color: #E4F0FBD0">print</span><span style="color: #A6ACCD">(p3)  </span><span style="color: #767C9DB0; font-style: italic"># prints: Point(x=25, y=31)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">p4 </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> Point(</span><span style="color: #5DE4C7">25</span><span style="color: #A6ACCD">, </span><span style="color: #5DE4C7">19</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #A6ACCD">lib.add_points_inplace(p3, p4)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E4F0FBD0">print</span><span style="color: #A6ACCD">(p3)  </span><span style="color: #767C9DB0; font-style: italic"># prints: Point(x=50, y=50)</span></span></code></pre>
  </article>
  </div>

</body></html>