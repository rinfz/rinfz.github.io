<!DOCTYPE html>
<!DOCTYPE html><html lang="en" class="astro-JT6RN32W">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Personal website of Matt R: programming, gamedev, music, tech and bird watching">
  <link rel="icon" type="image/x-icon" href="/images/favicon.png">
  <title>Barely Laughing - Unbounded sieve of Eratosthenes in Clojure</title>
<link rel="stylesheet" href="/assets/3e50419a.2d60ff92.css" />
<link rel="stylesheet" href="/assets/0692ffea.73ad435b.css" /></head>

<body class="astro-JT6RN32W">
  <div class="min-h-screen bg-gray-100 w-full sm:w-2/3 xl:w-3/5 max-w-screen-md mx-auto px-5 pb-0 sm:pb-5 astro-JT6RN32W">
    <header class="text-center py-10 border-b border-emerald-500 mb-2.5 text-sm font-semibold astro-JT6RN32W">
      <h1 class="astro-JT6RN32W">A Delightful Abstraction</h1>
    </header>

    <nav class="flex flex-col md:flex-row items-center border-b border-emerald-500 mb-5 pb-2.5 astro-JT6RN32W">
      <ul class="flex gap-5 flex-1 items-center astro-JT6RN32W">
        <li class="astro-JT6RN32W"><a href="/" class="astro-JT6RN32W">Home</a></li>
        <li class="astro-JT6RN32W"><a href="/posts" class="astro-JT6RN32W">Posts</a></li>
        <li class="astro-JT6RN32W"><a href="/birds" class="astro-JT6RN32W">Birds</a></li>
        <li class="astro-JT6RN32W"><a href="/photos" class="astro-JT6RN32W">Photography</a></li>
        <li class="astro-JT6RN32W"><a href="https://readwarbler.com/" target="_blank" class="astro-JT6RN32W">Reader</a></li>
      </ul>
      <p class="text-xs mt-3 md:mt-0"><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
    </nav>

    <article class="text-justify">
    <h2>Unbounded sieve of Eratosthenes in Clojure</h2>
    <p class="pt-0 mb-5">2022-07-29</p>
    <p>Recently I have restarted doing some <a href="https://projecteuler.net/about">project euler</a> problems. I have been implementing the solutions in Clojure because it’s been a while since I’ve played around with the language, and I rather enjoy it. Plus it’s a good excuse to learn how to think with a functional programming mindset.</p><p>Question 7 simply tells you to find the 10,001st prime number. Straight forward enough with a prime sieve. Because you need to find the nth prime, an unbounded prime sieve is required - usually you provide a limit and find all primes below that. We don’t know the value of the 10,001st prime so naturally we can’t provide a limit.</p><p>Since I’m doing this to learn Clojure, I’m not bothered about constructing an unbounded sieve from first principles. So I found the <a href="https://www.kylem.net/stuff/sieve_eratosthenes.html">following article</a> with a straightforward implementation in Python. It’s written in an imperative style so figuring out the details regarding tracking state, making it recursive etc provided a good learning experience.</p><p>First, I ported dict.setdefault (the version is hard-coded to resemble <code>defaultdict(list)</code>):</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">(defn setdefault [m k v]</span></span>
<span class="line"><span style="color: #A6ACCD">  (if (</span><span style="color: #ADD7FF">contains?</span><span style="color: #A6ACCD"> m k)</span></span>
<span class="line"><span style="color: #A6ACCD">    (</span><span style="color: #ADD7FF">update-in</span><span style="color: #A6ACCD"> m [k] conj v) </span><span style="color: #767C9DB0; font-style: italic">; k exists, append value to the vector at k</span></span>
<span class="line"><span style="color: #A6ACCD">    (</span><span style="color: #ADD7FF">assoc</span><span style="color: #A6ACCD"> m k [v])))        </span><span style="color: #767C9DB0; font-style: italic">; create a vector at k with v as the only elem</span></span></code></pre><p>Next, I worked my way out from the inner loop. I recognised that the for loop is just a reduction of setdefault on counters:</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">(defn update-counters [counters p]</span></span>
<span class="line"><span style="color: #A6ACCD">  (</span><span style="color: #ADD7FF">reduce</span><span style="color: #A6ACCD"> #(</span><span style="color: #ADD7FF">setdefault</span><span style="color: #A6ACCD"> % (</span><span style="color: #ADD7FF">+</span><span style="color: #A6ACCD"> p %</span><span style="color: #5DE4C7">2</span><span style="color: #A6ACCD">) %</span><span style="color: #5DE4C7">2</span><span style="color: #A6ACCD">) counters (</span><span style="color: #ADD7FF">get</span><span style="color: #A6ACCD"> counters p)))</span></span></code></pre><p>The harder part was getting the inner while loop working. It does, however, translate well into a recursive function. The bottom-out clause is the same the while loop (<code>p in counters</code> / <code>(contains? sieve p)</code>). Otherwise we calculate the state for the next call with <code>update-counters</code>, <code>dissoc</code> and <code>(inc n)</code>. Counters and p are placed in a vector ready to be handled by the next iteration.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">(defn primes-impl [counters p]</span></span>
<span class="line"><span style="color: #A6ACCD">  (loop [sieve counters n p]</span></span>
<span class="line"><span style="color: #A6ACCD">    (if (</span><span style="color: #ADD7FF">not</span><span style="color: #A6ACCD"> (</span><span style="color: #ADD7FF">contains?</span><span style="color: #A6ACCD"> sieve n))</span></span>
<span class="line"><span style="color: #A6ACCD">      [(</span><span style="color: #ADD7FF">assoc</span><span style="color: #A6ACCD"> sieve n [n]) n] </span><span style="color: #767C9DB0; font-style: italic">; loop terminates, update state</span></span>
<span class="line"><span style="color: #A6ACCD">      (recur (</span><span style="color: #ADD7FF">dissoc</span><span style="color: #A6ACCD"> (</span><span style="color: #ADD7FF">update-counters</span><span style="color: #A6ACCD"> sieve n) n) (</span><span style="color: #ADD7FF">inc</span><span style="color: #A6ACCD"> n)))))</span></span></code></pre><p>Since <code>primes-impl</code> returns the state which can be used for the next call, iterate is perfect for creating an infinite sequence of primes. <code>apply</code> is needed because <code>primes-impl</code> returns a vector but expects seperate args (I suppose primes-impl could also just take a vector to simplify the <code>iterate</code> call). Iterating <code>primes-impl</code> results in a sequence which includes all the state used for tracking, therefore <code>(map second ...)</code> is needed to just extract the primes.</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #A6ACCD">(defn primes []</span></span>
<span class="line"><span style="color: #A6ACCD">  (</span><span style="color: #ADD7FF">map</span><span style="color: #A6ACCD"> second (</span><span style="color: #ADD7FF">iterate</span><span style="color: #A6ACCD"> #(</span><span style="color: #ADD7FF">apply</span><span style="color: #A6ACCD"> primes-impl %) [{} </span><span style="color: #5DE4C7">2</span><span style="color: #A6ACCD">])))</span></span></code></pre><p>As for the actual problem, we can just use the <code>nth</code> function to get whichever prime we need:</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #a6accd">user=&gt; (nth (primes) 10001)</span></span>
<span class="line"><span style="color: #a6accd">104743</span></span></code></pre><p>Some benchmarks (no idea if these are performant or not):</p><pre class="astro-code" style="background-color: #1b1e28; overflow-x: auto;"><code><span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 1000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 40.3351 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">7919</span></span>
<span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 5000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 183.4985 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">48611</span></span>
<span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 10000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 209.0829 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">104729</span></span>
<span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 50000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 1351.956 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">611953</span></span>
<span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 100000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 3054.6579 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">1299709</span></span>
<span class="line"><span style="color: #a6accd">user=&gt; (time (nth (primes) 1000000))</span></span>
<span class="line"><span style="color: #a6accd">&quot;Elapsed time: 42555.3956 msecs&quot;</span></span>
<span class="line"><span style="color: #a6accd">15485863</span></span></code></pre>
  </article>
  </div>

</body></html>